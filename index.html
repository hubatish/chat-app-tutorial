<!doctype html>
<html lang="en">
    <head>
      <script src="/jquery/dist/jquery.js"></script>
      <script src="/socket.io/socket.io.js"></script>
      <script src="http://2a336fd6.ngrok.io/vorlon.js"></script>
      <!-- Client Socket Emit -->
      <script>
        // Can't use nice things like let, const, {name} cause iOs Safari..

        // Start socket on both localhost and AWS.
        var serverIp = window.location.href;
        var socket = io.connect(serverIp);

        var id = '';
        var gameStarted = false;
        var Role = {
          Werewolf: 'Werewolf',
          Villager: 'Villager',
          Seer: 'Seer'
        };
        var role = Role.Villager;
        var allPlayersNames = [];
        var shouldShowSeer = false;
        var votedPlayer = '';

        function setListEntries(list_root, names) {
          list_root.empty();
          for (var name of names) {
            list_root.append("<li>"+name+"</li>");
          }
        }

        function startCountDown(totalSeconds, onDone) {
          var seconds = totalSeconds;
          var countdownText = $('#countdown-text');
          function tickSecond() {
            seconds--;
            var minutes = 0;
            if (seconds == 0) {
              onDone();
              return;
            }
            if (seconds >= 60) {
              seconds = 0;
              minutes = seconds % 60;
            }
            countdownText.text((minutes ? (minutes > 9 ? minutes : minutes) : "0") + ":" + (seconds > 9 ? seconds : "0" + seconds));

            timer();
          }
          function timer() {
              t = setTimeout(tickSecond, 1000);
          }
          tickSecond();
        }


        $(function() {
          // document ready.
          // Set up name changing.
          $('#name_form').submit(function(e){
            e.preventDefault();
            var name = $('#name_input').val();
            socket.emit('nameSet', {name: name});
            $("#name_form").hide();
            $("#name_change_btn").text("Change name from " + name);
            $("#name_change_btn").show();
            if (!gameStarted) {
              $("#start_game_root").show();
            }
          });
          $("#name_change_btn").click(function() {
            $("#name_form").show();
            $("#name_change_btn").hide();
          });

          $('#start_game_btn').click(function() {
            socket.emit('startGame', {});
            $('#start_game_root').hide();
          });
        });

        socket.on('connect', function(data) {
          socket.emit('join', {});
        });

        socket.on('clientJoin', function(data) {
          id = data.id;
          // durrr don't really need id...
          // got back id - show the starting screen & hide loading.
          $("#name_change_root").show();
          $("#loading").hide();
          $("#player_list_root").show();
        });

        function setPlayerNamesList(names) {
          allPlayersNames = names;
          $('#player_list').empty();
          for (var name of names) {
            var innerHtml = '<li>' + name;
            if (shouldShowSeer) {
              innerHtml += '<button id="seer_'+name+'">View Role</button>';
            }
            if (gameStarted) {
              console.log('game started here comes html!');
              innerHtml += '<button id="vote_'+name+'">Vote to Lynch</button>';
              if (votedPlayer == name) {
                innerHtml += "Voted For!"
              }
            }
            innerHtml += '</li>';
            $('#player_list').append(innerHtml);
            if (shouldShowSeer) {
              $('#seer_'+name).click(function(unused) {
                console.log('seer clicked on' + name);
                socket.emit('viewRole', {name: name});
                shouldShowSeer = false;
                setPlayerNamesList(allPlayersNames);
              });
            }
            if (gameStarted) {
              $('#vote_' + name).click(function(unused) {
                console.log('voted for ' + name);
                votedPlayer = name;
                //socket.emit('voteFor', {name: name});
                setPlayerNamesList(allPlayersNames);
              });
            }
          }
        }
        socket.on('allPlayersNames', function(names) {
          setPlayerNamesList(names);
        });

        socket.on('tellRole', function(player) {
          if (role == Role.Seer) {
            $('#seer_start').hide();
            $('#seer_reveal').show();
            $('#seer_reveal').text('Player ' + player.name + ' has role ' + player.role);
          }
        });

        socket.on('startGame', function(data) {
          console.log('game started msg received' + data.role);
          gameStarted = true;
          role = data.role;
          $('#start_game_root').hide();
          $('#ability_root').show();
          $('#role_text').text('Role: ' + role);
          startCountDown(60, function() {
            console.log('times up!');
          });

          // handle the ability:
          switch(role) {
            case Role.Werewolf:
              $('#werewolf_root').show();
              setListEntries($('.werewolf_list'), data.werewolves);
              break;
            case Role.Seer:
              $('#seer_root').show();
              $('#seer_start').show();
              shouldShowSeer = true;
              break;
            case Role.Villager:
              $('#villager_root').show();
              break;
            default:
              break;
          }

          setPlayerNamesList(allPlayersNames);
        });
       </script>
    </head>
    <body>
      <h1>Play Werewolf!</h1>
      <div hidden id="name_change_root">
        <form id="name_form">
          <input id="name_input" type="text">
          <input type="submit" value="Set Name">
        </form>
        <button hidden id="name_change_btn">Change your name.</button>
      </div>
      <div hidden id="start_game_root">
        <p>After five minutes, vote to kill someone. The werewolves and minion win if a werewolf is not killed.</p>
        <button id="start_game_btn">Start Round</button>
        <p>^ Press only when everyone is ready.</p>
      </div>
      <p id="loading">Loading..</p>
      <div hidden id="ability_root">
        <p id="role_text">Role: </p>
        <div hidden id="werewolf_root">
          <p>The werewolves are:</p>
          <ul class="werewolf_list"></ul>
        </div>
        <div hidden id="villager_root">
          <p>The villager has no special abilities. Sorry! Talk it out.</p>
        </div>
        <div hidden id="seer_root">
          <p id="seer_start">Click one of the players below to see their role.</p>
          <p hidden id="seer_reveal"></p>
        </div>
        <div>
          <p>Vote before time is out!</p>
          <p id="countdown-text"></p>
        </div>
      </div>
      <div hidden id="player_list_root">
          <p>Players</p>
          <ul id="player_list"></ul>
        </div>
      </body>
</html>  
